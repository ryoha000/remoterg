# スクリーンショット機能仕様書

## 1. プロジェクト概要

本ドキュメントは、WebRTCを用いたPCウィンドウ共有アプリケーションにおける、スクリーンショットの取得・転送・保存、および管理機能に関する仕様を定義する。

---

## 2. システム要件

### 2.1 機能要件

- **双方向保存:** スクリーンショット取得時、ホスト側（配信元）とクライアント側（閲覧元）の両方に画像を保存する。
- **双方向管理:** 保存された画像を、それぞれのアプリ内ギャラリーで管理・閲覧可能とする。
- **クライアント主導のトリガー:** クライアント側からの操作（ボタンまたはジェスチャー）でキャプチャを実行する。
- **リッチなUX:** クライアント側では、データ転送完了後に画像が画面端（左側）へ流れるスタックアニメーションを提供する。

### 2.2 非機能要件

- **高画質:** ホスト側のウィンドウ解像度を維持したキャプチャを行う。
- **拡張性:** 将来的な「タグ付け」「検索」「同期」に対応可能なデータ構造とする。
- **マルチプラットフォーム:** クライアントはWeb（React）およびモバイル（React Native）の両方に対応する。

---

## 3. 技術スタック

| コンポーネント              | 技術選定                                                   |
| --------------------------- | ---------------------------------------------------------- |
| **ホスト側 (Rust)**         | `GraphicsCapture` API (Windows), WebRTC (DataChannel)      |
| **クライアント側 (Web)**    | React, Framer Motion (アニメーション), IndexedDB (管理用)  |
| **クライアント側 (Mobile)** | React Native, Reanimated (アニメーション), SQLite (管理用) |
| **通信プロトコル**          | WebRTC DataChannel (`ordered: true`)                       |

---

## 4. 通信プロトコル定義

データ転送は、不整合を防ぐため **[メタデータ送信] → [バイナリ転送]** の2ステップで行う。

### 4.1 メタデータ (JSON)

ホストはキャプチャ完了後、以下の情報をDataChannel経由で送信する。

```json
{
  "type": "SCREENSHOT_METADATA",
  "payload": {
    "id": "UUID-V4",
    "timestamp": 1705494620,
    "format": "png",
    "width": 1920,
    "height": 1080
  }
}
```

### 4.2 バイナリ転送

メタデータ送信直後に画像のバイナリデータを送信する。受信側は `ordered: true` により順序通りに受信し、メタデータのIDと紐付けて結合する。

---

## 5. ジェスチャー判定仕様

マウスまたはトラックパッドの軌跡をアルゴリズム（$1 Recognizer等）で判定する。

### 5.1 プリセットパターン

1. **V-Shape (くの字):** シンプルで描きやすく、誤爆が少ない。
2. **Left-Arrow (←):** 保存先（左側）を指し示す直感的な動き。
3. **Diagonal (対角線):** 画面を大きく横断する動作。意図的な操作として定義。

---

## 6. ストレージ・管理戦略

「ユーザーの利便性」と「アプリ内の管理」を両立するため、**二重保持戦略**を採用する。

| 保存場所                 | 用途                   | 実装詳細                                                          |
| ------------------------ | ---------------------- | ----------------------------------------------------------------- |
| **OS標準フォルダ**       | ユーザーの自由な利用   | ホスト：ピクチャフォルダ / クライアント：カメラロール・DLフォルダ |
| **アプリ専用ストレージ** | アプリ内ギャラリー管理 | Web：IndexedDB / Mobile：Internal Storage                         |

### データ管理構造

ギャラリー機能のため、以下の情報をローカルDB（IndexedDB/SQLite）に保持する。

- `id` (UUID): ホスト・クライアント共通の識別子
- `local_path`: 各端末内での画像パス
- `timestamp`: 撮影日時
- `tags`: 将来拡張用（文字列配列）

---

## 7. UI/UX 仕様：アニメーションフロー

1. **トリガー:** クライアントがジェスチャーを完遂。
2. **待機:** ホストへ要求を送り、データの受信を開始（バックグラウンド）。
3. **発火:** バイナリ受信が完了し、画像のデコードが成功したタイミング。
4. **演出:**

- 画面中央に画像がポップアップ。
- 滑らかに縮小しながら画面左側（または左下のギャラリーアイコン）へ移動。
- ギャラリーのスタックに吸い込まれて消える。
